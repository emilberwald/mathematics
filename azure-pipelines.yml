# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

name: $(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
trigger:
 - master

jobs:
- job: Testing
  pool:
    vmImage: 'Ubuntu-16.04'
  strategy:
    matrix:
      Python37:
        python.version: '3.7'
  steps:
  - template: azure-pipelines-dependencies.yml
  - script: |
        ls -latr
        pip install pytest pytest-azurepipelines pytest-cov
        python -m pytest mathematics --cov mathematics --cov-report html
    displayName: 'pytest'

- job: Linting
  pool:
    vmImage: 'Ubuntu-16.04'
  strategy:
    matrix:
      Python37:
        python.version: '3.7'
  steps:
  - template: azure-pipelines-dependencies.yml
  - script: |
      ls -latr
      pip install pylint
      python -m pylint --output-format=json --reports=y mathematics | tee pylint.json
    displayName: 'pylint'

  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'pylint'
      targetPath: 'pylint.json'

- job: Documentation
  pool:
    vmImage: 'Ubuntu-16.04'
  strategy:
    matrix:
      Python37:
        python.version: '3.7'
  variables:
      AUTHOR: "Emil Berwald"
      SPHINX_APIDOC_OPTIONS: "members,undoc-members,private-members,special-members,show-inheritance"
  steps:
  - template: azure-pipelines-dependencies.yml
  - script: |
        ls -latr
        pip install --upgrade sphinx
        sphinx-apidoc --full -a -H "$TeamProject" -A "$AUTHOR" -V "$SourceBranchName" -R "$SourceBranchName.$BuildID" -o "docs" "mathematics"
        echo 'extensions.append("sphinx.ext.mathjax")' >> docs/conf.py
        echo 'mathjax_path="MathJax/MathJax.js?config=TeX-MML-AM_CHTML"' >> docs/conf.py
        git clone --depth 1 --branch master https://github.com/mathjax/MathJax.git docs/_static/MathJax
        cd docs
        make html
    displayName: 'sphinx'

  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'docs'
      targetPath: 'mathematics/docs'

